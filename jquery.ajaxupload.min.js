AjaxUploader=function(e){var t={msgUploading:"Uploading file",msgUploadError:"Error uploading file",msgUploadSuccess:"File successfuly uploaded",msgDeleteConfirm:"Do you really want delete given photo?",selInputWrapper:!1,selThumbnails:!1,selThumnailWrapper:".attachment",selMessages:!1,selFormMirror:!1,djangoCsrf:!0,onUpload:!1,beforeUpload:!1};this.opts=$.extend(t,e||{}),this.canvasItems={},this.uploadIframe=!1,this.init()},AjaxUploader.prototype={constructor:AjaxUploader,init:function(){var e=this;e.uploadPhotoHook(),e.deletePhotoHook()},deletePhotoHook:function(){var e=this;$(e.opts.selThumbnails).on("click","input.delete",function(){return e.deletePhoto(this),!1})},getCsrfToken:function(){var e="csrftoken",t=null;if(document.cookie&&document.cookie!=""){var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=jQuery.trim(n[r]);if(i.substring(0,e.length+1)==e+"="){t=decodeURIComponent(i.substring(e.length+1));break}}}return t},deletePhoto:function(e){var t=this;if(!confirm(t.opts.msgDeleteConfirm))return;$.ajax({url:$(e).data("url"),type:"POST",beforeSend:function(e){t.opts.djangoCsrf&&e.setRequestHeader("X-CSRFToken",t.getCsrfToken())},success:function(){$(e).closest(t.opts.selThumnailWrapper).remove()}})},uploadPhotoHook:function(){var e=this;$("input[type=file]",e.opts.selInputWrapper).on("change",function(){this.value&&e.uploadFile(this)})},uploadFile:function(e){var t=this,n=t.opts.beforeUpload?t.opts.beforeUpload(e):t.beforeUpload(e),r=t.createIframe();if(t.opts.selFormMirror){var i=$(e).clone(!0);i.insertBefore(e),$(t.opts.selFormMirror).attr("target",r).find("input[type=file]").remove().end().append(e).submit()}else $(t.opts.selInputWrapper).closest("form").attr("target",r).submit()},createIframe:function(){var e=this;if(!e.uploadIframe){var t="upload_"+Math.random()*1e5;$(e.opts.selInputWrapper).closest("form").attr("target",t);var n=$('<iframe name="'+t+'" style="position:absolute;top:-9999px;" />').appendTo("body");n.load(function(){var t=n[0].contentWindow.document.body.textContent;t&&(e.opts.onUpload?e.opts.onUpload(t):e.onUpload(t))}),e.uploadIframe=n}return e.uploadIframe.attr("name")},getCanvasItems:function(e){var t=this;if(!t.canvasItems.length){var n=$(t.opts.selMessages);for(var r in{alert:1,progress:1}){var i=n.find("."+r);i.length||(i=$('<div class="'+r+'" style="display:none;"/>'),n.append(i)),t.canvasItems[r]=i}}return e?t.canvasItems[e]:t.canvasItems},beforeUpload:function(e){var t=this,n=e.value.split(/[\/\\]/).pop();return t.getCanvasItems("progress").show(),t.showMsg(t.opts.msgUploading+" "+n,"info"),!0},showMsg:function(e,t){var n=this;if(!n.opts.selMessages)return;var r={error:1,info:1,success:1,warning:1},i=n.getCanvasItems("alert");for(var s in r)i.removeClass("alert-"+s);r.hasOwnProperty(t)&&i.addClass("alert-"+t),i.html(e).show()},onUpload:function(e){var t=this;$("input[type=file]",t.opts.selInputWrapper).val(""),t.getCanvasItems("progress").hide();if(!e)return;try{var n=$.parseJSON(e)}catch(r){t.showMsg(t.opts.msgUploadError,"error");return}if(n.status!="success"){t.showMsg(t.opts.msgUploadError,"error");return}t.showMsg(t.opts.msgUploadSuccess,"success");if(!t.opts.selThumbnails)return;n.file.html&&$(t.opts.selThumbnails).append(n.file.html)}};

